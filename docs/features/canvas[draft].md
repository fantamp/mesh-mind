# Canvas (Канвас)

## Overview
Переход от линейной модели "сообщений" к пространственной модели "элементов на канвасе" как центральной сущности для работы с информацией. Канвас — это абстрактное, бесконечное пространство для творческого процесса, позволяющее структурировать, группировать и развивать идеи из различных источников.
Ключевой сдвиг: уход от понятия "сообщение" к универсальному понятию **"элемент"** и группировка этих элементов во **"фреймы"** (frames) внутри канваса.



## Problem Statement
*   **Ограниченность линейного чата**: Сложно работать со сложными структурами данных и идей в рамках последовательной ленты сообщений.
*   **Потеря контекста**: Идеи и файлы теряются в потоке переписки, их сложно группировать и связывать между собой.
*   **Разрозненность источников**: Информация поступает из разных каналов (Telegram, email, файлы, внешние сервисы) и не имеет единого пространства для обработки.

## Solution Statement

### Концепция
*   **Сдвиг парадигмы**: Уход от понятия "сообщение" к понятию "элемент на канвасе".
*   **Природа канваса**: Абстрактное, бесконечное пространство для творчества (чистый холст). Не обязательно визуальное в первой итерации, но с возможностью визуализации в будущем (например, через Miro).

### Элементы канваса
*   **Типы объектов**: Текстовые стикеры, картинки, голосовые сообщения, документы, ссылки на внешний мир.
*   **Автоматическое формирование**: Объекты создаются из сообщений чата (например, голосовое сообщение -> объект с транскрипцией, аудиофайлом и атрибутами), но не ограничиваются ими.
*   **Источники**: Система интегрируется с различными источниками событий/сообщений: Telegram, email, файлы, внешние сервисы (например, ChatGPT), API других систем.
*   **Идентификация**: Каждый элемент имеет свой уникальный ID.
*   **Метаинформация**: Передается вместе с объектом (например, link to message для Telegram-источников), позволяя агентам взаимодействовать с источником (например, отправить реплай в чат). Важно: "реплай в чате" — это лишь один из сценариев для Telegram, другие источники могут иметь свои механизмы обратной связи.

### Структура
*   **Root Canvas**: Каждый чат имеет свой корневой канвас с уникальным ID.
*   **Фреймы (Frames)**: Внутри корневого канваса создаются **фреймы** для группировки объектов.
*   **Вложенность**: На старте ограничиваемся **1 уровнем вложенности** (Канвас -> Фреймы -> Элементы).
*   **Типизация**: Фреймы могут иметь типы (например, "комната", "брейншторм", "архив").
*   **Адресуемость**: Фреймы имеют уникальные, понятные имена. Это позволяет сценарии вида: *"Докинь во фрейм 'Business Development' тезис о том, что клиентов можно искать на выставках"*.

### Взаимодействие с агентами
*   **Обработка**: Агенты группируют, суммируют и развивают идеи, организуя их во **фреймы**.

*   **Поток данных**: Агенты получают на вход множества элементов или целые фреймы.
*   **Агент-обозреватель**: Перемещается по канвасу, может собирать "бакеты" сообщений и создавать из них новые фреймы для других агентов.
*   **Выполнение задач**: Агенты используют элементы для конкретных действий.

### Идеи инструментов (Tool Ideas)
*   **Mindmap Builder**: Инструмент для суммаризатора, позволяющий строить визуальные карты связей на основе объектов канваса.

### Функциональность
*   **Фильтрация**: **Оркестратор** самостоятельно решает, какие сообщения сохранять на канвас и в каком виде. Служебные команды и "мусорные" сообщения отфильтровываются и не попадают на канвас.
*   **Smart Retrieval**: Инструменты выборки возвращают релевантный "топ" объектов, а не все подряд. Это критически важно для **экономии токенов** и управления контекстом, так как чаты со временем накапливают огромный объем информации.
*   **Экспорт**: Отдельный инструмент (вероятно, у Обозревателя) для выгрузки объектов канваса (например, в zip-архив с исходными данными). *Открытый вопрос: механизм доставки архива пользователю.*

## Value Statement
*   **Единое пространство смыслов**: Вся важная информация из разных источников собрана и структурирована в одном месте.
*   **Улучшенная работа агентов**: Агенты получают доступ к структурированному контексту, а не просто к "истории чата".
*   **Масштабируемость мышления**: Возможность работать со сложными концепциями через иерархию и группировку.

## Architecture / Technical details

### Backlog & Open Questions

#### Technical Choice
*   **Database**: Выбор БД (SQLite, Mongo, etc.) для хранения графа объектов.

#### Product Discovery / Research
*   **Agent Outputs**: Нужно ли сохранять ответы агентов как элементы канваса? *Проблема*: Сейчас боты помнят свои ответы только в рамках текущей сессии (in-memory). При рестарте сервиса этот контекст теряется. Сохранение ответов как элементов канваса обеспечит персистентность диалога.

*   **Multi-tenancy**: Архитектура для поддержки множества чатов. *Риски*: Необходима строгая изоляция по `chat_id`, чтобы предотвратить утечку информации между контекстами разных групп. Учитывать риск "протекания" данных при использовании общих моделей или векторных индексов.

*   **Market Research**: Исследование аналогов для уточнения проблем и решений.
